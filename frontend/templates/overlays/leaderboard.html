{% extends "base/base_overlay.html" %}

{% block title %}Leaderboard{% endblock %}

{% block content %}
<div class="app">
    <section class="card">
        <div class="thead">
            <div>Pos</div>
            <div>Driver</div>
            <div>Rating</div>
            <div>Last Lap</div>
            <div>Gap</div>
        </div>

        <!-- Ahead Cars (up to 3) -->
        <div id="ahead-row-1" class="row ahead" style="display: none;">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
            </div>
            <div class="lic-column">
                <div class="lic-container">
                    <span class="lic">--</span>
                    <span class="ir">--</span>
                </div>
            </div>
            <div class="time">--:--.---</div>
            <div class="gap">--</div>
        </div>

        <div id="ahead-row-2" class="row ahead" style="display: none;">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
            </div>
            <div class="lic-column">
                <div class="lic-container">
                    <span class="lic">--</span>
                    <span class="ir">--</span>
                </div>
            </div>
            <div class="time">--:--.---</div>
            <div class="gap">--</div>
        </div>

        <div id="ahead-row-3" class="row ahead" style="display: none;">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
            </div>
            <div class="lic-column">
                <div class="lic-container">
                    <span class="lic">--</span>
                    <span class="ir">--</span>
                </div>
            </div>
            <div class="time">--:--.---</div>
            <div class="gap">--</div>
        </div>

        <!-- Player Car -->
        <div id="player-row" class="row me">
            <div class="pos-car-badge">
                <div class="pos me">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver"><div class="name">Loading...</div></div>
            <div class="lic-column">
                <div class="lic-container">
                    <span class="lic">--</span>
                    <span class="ir">--</span>
                </div>
            </div>
            <div class="time">--:--.---</div>
            <div class="gap">0.0</div>
        </div>

        <!-- Behind Cars (up to 3) -->
        <div id="behind-row-1" class="row behind" style="display: none;">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
            </div>
            <div class="lic-column">
                <div class="lic-container">
                    <span class="lic">--</span>
                    <span class="ir">--</span>
                </div>
            </div>
            <div class="time">--:--.---</div>
            <div class="gap">--</div>
        </div>

        <div id="behind-row-2" class="row behind" style="display: none;">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
            </div>
            <div class="lic-column">
                <div class="lic-container">
                    <span class="lic">--</span>
                    <span class="ir">--</span>
                </div>
            </div>
            <div class="time">--:--.---</div>
            <div class="gap">--</div>
        </div>

        <div id="behind-row-3" class="row behind" style="display: none;">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
            </div>
            <div class="lic-column">
                <div class="lic-container">
                    <span class="lic">--</span>
                    <span class="ir">--</span>
                </div>
            </div>
            <div class="time">--:--.---</div>
            <div class="gap">--</div>
        </div>

        <div class="tfoot">
            <div class="race-stats">
                <span class="label">LAPS</span>
                <span id="laps-current" class="value">--</span>
                <span class="sep">/</span>
                <span id="laps-total" class="value">--</span>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
class LeaderboardUpdater {
    constructor() {
        this.updateInterval = 100;
        this.init();
    }

    init() {
        this.updateLeaderboard();
        setInterval(() => this.updateLeaderboard(), this.updateInterval);
    }

    async updateLeaderboard() {
        try {
            const response = await fetch('/api/leaderboard');
            const data = await response.json();

            if (data.error) {
                this.showError(data.error);
                return;
            }

            this.renderLeaderboard(data);

        } catch (error) {
            this.showError('Failed to fetch data');
            console.error('Error:', error);
        }
    }

    renderLeaderboard(data) {
        // Hide all neighbor rows first
        for (let i = 1; i <= 3; i++) {
            document.getElementById(`ahead-row-${i}`).style.display = 'none';
            document.getElementById(`behind-row-${i}`).style.display = 'none';
        }

        // Render the player
        this.renderPlayer(data.player);

        const aheadCars = data.neighbors.ahead || [];
        const behindCars = data.neighbors.behind || [];
        const displayedAheadCars = [...aheadCars].reverse();
        
        // Render ahead cars - farthest ahead in row 1, then closer cars in row 2, etc.
        for (let i = 0; i < 3; i++) {
            const rowId = `ahead-row-${i + 1}`;
            if (i < displayedAheadCars.length) {
                this.renderCar(rowId, displayedAheadCars[i], true);
            }
        }

        // Render behind cars - closest behind goes in row 1, then row 2, etc. (no reverse needed)
        for (let i = 0; i < 3; i++) {
            const rowId = `behind-row-${i + 1}`;
            if (i < behindCars.length) {
                this.renderCar(rowId, behindCars[i], false);
            }
        }

        // Update session laps
        this.updateSessionLaps(
            data.leaderboard_data.session_laps,
            data.leaderboard_data.session_time,
            data.leaderboard_data.player_lap_time,
            data.player.laps_started
        );
    }

    renderPlayer(player) {
        const row = document.getElementById('player-row');
        this.renderRow(row, player);

        const posElement = row.querySelector('.pos');
        if (posElement && !posElement.classList.contains('me')) {
            posElement.classList.add('me');
        }

        const gapElement = row.querySelector('.gap');
        if (gapElement) {
            gapElement.textContent = '0.0';
        }
    }

    renderCar(rowId, car, isAhead) {
        const row = document.getElementById(rowId);
        row.style.display = 'grid';
        this.renderRow(row, car, isAhead);
    }

    hexToRgb(hex) {
        let c = hex.replace('#','');
        if (c.length === 3) {
            c = c.split('').map(ch => ch + ch).join('');
        }
        const bigint = parseInt(c, 16);
        const r = (bigint >> 16) & 255;
        const g = (bigint >> 8) & 255;
        const b = bigint & 255;
        return [r, g, b];
    }

    applyGradient(numElement, hexColor) {
        const [r,g,b] = this.hexToRgb(hexColor);
        numElement.style.backgroundImage = `
            linear-gradient(to right,
                rgba(${r},${g},${b},1),
                rgba(${r},${g},${b},0.2),
                rgba(${r},${g},${b},0)
            )
            `;
    }

    renderRow(rowElement, car, isAhead = null) {
        rowElement.querySelector('.pos').textContent = car.pos || '--';
        const numElement = rowElement.querySelector('.num');
        numElement.textContent = `#${car.car_number}` || '--';
        const DARKEN_PERCENT = 20;

        if (car.car_class_color) {
            if (car.car_class_color.toUpperCase() === '#FFFFFF') {
                numElement.style.backgroundImage = 'none';
                numElement.style.fontWeight = 'normal';
            } else {
                this.applyGradient(numElement, car.car_class_color);
                numElement.style.fontWeight = 'normal';
            }
        } else {
            numElement.style.backgroundImage = '';
            numElement.style.color = ''; 
        }

        const driverElement = rowElement.querySelector('.driver');
        const nameElement = driverElement.querySelector('.name');
        nameElement.textContent = car.name || 'Unknown';

        const licElement = rowElement.querySelector('.lic');
        if (car.license) {
            let licenseText = car.license;
            if (licenseText.length > 5) {
                licenseText = licenseText.slice(0, 5) + licenseText.slice(6);
            }
            licElement.textContent = licenseText;
            licElement.className = 'lic';
            licElement.classList.add(licenseText.charAt(0).toLowerCase());
        } else {
            licElement.textContent = '--';
            licElement.className = 'lic';
        }

        const irElement = rowElement.querySelector('.ir');
        irElement.textContent = car.irating
            ? (Math.floor(car.irating / 100) / 10).toFixed(1) + 'k'
            : '--';

        this.updateLapTime(rowElement, car.last_lap);
        this.updateGap(rowElement, car.gap_sec);
    }

    updateLapTime(row, lapTime) {
        row.querySelector('.time').textContent = lapTime || '--:--.---';
    }

    updateGap(row, gapSec) {
        const gapElement = row.querySelector('.gap');
        if (!gapElement) return;
        if (gapSec === undefined || gapSec === null) {
            gapElement.textContent = '--';
        } else {
            gapElement.textContent = `${gapSec.toFixed(1)}`;
        }
    }

    updateSessionLaps(sessionLaps, sessionTime, playerLapTime, lapsStarted) {
        const currentElement = document.getElementById('laps-current');
        const totalElement = document.getElementById('laps-total');

        if (sessionLaps !== "unlimited") {
            currentElement.textContent = lapsStarted;
            totalElement.textContent = sessionLaps;
        } else {
            currentElement.textContent = lapsStarted;
            totalElement.textContent = `~${(sessionTime / playerLapTime).toFixed(1)}`;
        }
    }

    showError(message) {
        console.error('Error:', message);
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    new LeaderboardUpdater();
});
</script>
{% endblock %}
