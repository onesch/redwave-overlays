{% extends "base/base_overlay.html" %}

{% block title %}Leaderboard{% endblock %}

{% block content %}
<div class="app">
    <section class="card">
        <div class="thead">
            <div>POS #</div>
            <div>Driver</div>
            <div>Last Lap</div>
        </div>

        <!-- Ahead Car -->
        <div id="ahead-row" class="row" style="display: none;">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
                <div class="meta">
                    <div class="lic-container">
                        <span class="lic">--</span>
                        <span class="ir">--</span>
                    </div>
                </div>
            </div>
            <div class="time">--:--.---</div>
        </div>

        <!-- Player Car -->
        <div id="player-row" class="row me">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
                <div class="meta">
                    <div class="lic-container">
                        <span class="lic">--</span>
                        <span class="ir">--</span>
                    </div>
                </div>
            </div>
            <div class="time">--:--.---</div>
        </div>

        <!-- Behind Car -->
        <div id="behind-row" class="row" style="display: none;">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
                <div class="meta">
                    <div class="lic-container">
                        <span class="lic">--</span>
                        <span class="ir">--</span>
                    </div>
                </div>
            </div>
            <div class="time">--:--.---</div>
        </div>

        <div class="tfoot">
            <div id="race-laps" class="race-laps">LAPS 0/0</div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
class LeaderboardUpdater {
    constructor() {
        this.updateInterval = 500;
        this.init();
    }

    init() {
        this.updateLeaderboard();
        setInterval(() => this.updateLeaderboard(), this.updateInterval);
    }

    async updateLeaderboard() {
        try {
            const response = await fetch('/api/leaderboard');
            const data = await response.json();

            if (data.error) {
                this.showError(data.error);
                return;
            }

            this.renderLeaderboard(data);

        } catch (error) {
            this.showError('Failed to fetch data');
            console.error('Error:', error);
        }
    }

    renderLeaderboard(data) {
        // First we hide all rows
        document.getElementById('ahead-row').style.display = 'none';
        document.getElementById('behind-row').style.display = 'none';

        // Render the player
        this.renderPlayer(data.player);

        // Render neighbors
        const neighbors = data.neighbors;
        if (neighbors.ahead) this.renderCar('ahead', neighbors.ahead);
        if (neighbors.behind) this.renderCar('behind', neighbors.behind);

        // Update session laps separately
        this.updateSessionLaps(
            data.leaderboard_data.session_laps,
            data.leaderboard_data.session_time,
            data.leaderboard_data.car_est_lap_time,
            data.player.laps_started
        );
    }

    renderPlayer(player) {
        const row = document.getElementById('player-row');
        this.renderRow(row, player);
    }

    renderCar(sectionId, car) {
        const row = document.getElementById(sectionId + '-row');
        row.style.display = 'grid';
        this.renderRow(row, car);
    }

    renderRow(rowElement, car) {
        rowElement.querySelector('.pos').textContent = car.pos || '--';
        rowElement.querySelector('.num').textContent = car.car_number || '--';
        rowElement.querySelector('.name').textContent = car.name || 'Unknown';

        const licElement = rowElement.querySelector('.lic');
        if (car.license) {
            licElement.textContent = car.license;
            licElement.className = 'lic';
            licElement.classList.add(car.license.charAt(0).toLowerCase());
        } else {
            licElement.textContent = '--';
            licElement.className = 'lic';
        }

        const irElement = rowElement.querySelector('.ir');
        irElement.textContent = car.irating
            ? (car.irating / 1000).toFixed(1) + 'k' 
            : '--';

        this.updateLapTime(rowElement, car.last_lap);
    }

    updateLapTime(row, lapTime) {
        row.querySelector('.time').textContent = lapTime || '--:--.---';
    }

    updateSessionLaps(sessionLaps, sessionTime, carEstLapTime, lapsStarted) {
        const lapsElement = document.getElementById('race-laps');
        let lapsDisplay = '';

        if (sessionLaps !== "unlimited") {
            lapsDisplay = `${lapsStarted}/${sessionLaps}`;
        } else {
            const approxLaps = (sessionTime / carEstLapTime).toFixed(1);
            lapsDisplay = `${lapsStarted}/~${approxLaps}`;
        }

        lapsElement.textContent = `LAPS ${lapsDisplay}`;
    }

    showError(message) {
        console.error('Error:', message);
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    new LeaderboardUpdater();
});
</script>
{% endblock %}
