{% extends "base/base_overlay.html" %}

{% block title %}Leaderboard{% endblock %}

{% block content %}
<div class="app">
    <section class="card">
        <div class="thead">
            <div>POS #</div>
            <div>Driver</div>
            <div>Last Lap</div>
        </div>

        <!-- Ahead Car -->
        <div id="ahead-row" class="row" style="display: none;">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
                <div class="meta">
                    <div class="lic-container">
                        <span class="lic">--</span>
                        <span class="ir">--</span>
                    </div>
                </div>
            </div>
            <div class="time">--:--.---</div>
        </div>

        <!-- Player Car -->
        <div id="player-row" class="row me">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
                <div class="meta">
                    <div class="lic-container">
                        <span class="lic">--</span>
                        <span class="ir">--</span>
                    </div>
                </div>
            </div>
            <div class="time">--:--.---</div>
        </div>

        <!-- Behind Car -->
        <div id="behind-row" class="row" style="display: none;">
            <div class="pos-car-badge">
                <div class="pos">--</div>
                <div class="car">
                    <span class="num">--</span>
                </div>
            </div>
            <div class="driver">
                <div class="name">Loading...</div>
                <div class="meta">
                    <div class="lic-container">
                        <span class="lic">--</span>
                        <span class="ir">--</span>
                    </div>
                </div>
            </div>
            <div class="time">--:--.---</div>
        </div>

        <div class="tfoot">
            <div id="race-laps" class="race-laps">LAPS 0/0</div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
class LeaderboardUpdater {
    constructor() {
        this.updateInterval = 500;
        this.init();
    }

    init() {
        this.updateLeaderboard();
        setInterval(() => this.updateLeaderboard(), this.updateInterval);
    }

    async updateLeaderboard() {
        try {
            const response = await fetch('/api/leaderboard');
            const data = await response.json();

            if (data.error) {
                this.showError(data.error);
                return;
            }

            this.renderLeaderboard(data);

        } catch (error) {
            this.showError('Failed to fetch data');
            console.error('Error:', error);
        }
    }

    renderLeaderboard(data) {
        // First we hide all rows
        document.getElementById('ahead-row').style.display = 'none';
        document.getElementById('behind-row').style.display = 'none';

        // Render the player
        this.renderPlayer(data.player, data.leaderboard_data.total_laps);

        // Render neighbors
        const neighbors = data.neighbors;
        let hasNeighbors = false;

        if (neighbors.ahead) {
            this.renderCar('ahead', neighbors.ahead);
            hasNeighbors = true;
        }

        if (neighbors.behind) {
            this.renderCar('behind', neighbors.behind);
            hasNeighbors = true;
        }
    }

    renderPlayer(player, totalLaps) {
        const row = document.getElementById('player-row');
        const lapsElement = document.getElementById('race-laps');
        
        // Update data
        row.querySelector('.pos').textContent = player.pos || '--';
        row.querySelector('.num').textContent = player.car_number || '--';
        row.querySelector('.name').textContent = player.name || 'Unknown';
        const licElement = row.querySelector('.lic');
        const irElement = row.querySelector('.ir');

        // License, Add a class by the first letter of the license
        if (player.license) {
            licElement.textContent = player.license;
            licElement.className = 'lic';
            const licClass = player.license.charAt(0).toLowerCase();
            licElement.classList.add(licClass);
        } else {
            licElement.textContent = '--';
            licElement.className = 'lic';
        }

        // iRating
        irElement.textContent = player.irating ? Math.floor(player.irating/100)/10 + 'k' : '--';

        // Update the last lap time
        row.querySelector('.time').textContent = player.last_lap || '--:--.---';

        // Update player the laps completed counter
        lapsElement.textContent = `LAPS ${player.laps_completed}/${totalLaps || '∞'}`;
    }

    renderCar(sectionId, car) {
        const row = document.getElementById(sectionId + '-row');
        row.style.display = 'grid'; // Показываем ряд

        // Update data
        row.querySelector('.pos').textContent = car.pos || '--';
        row.querySelector('.num').textContent = car.car_number || '--';
        row.querySelector('.name').textContent = car.name || 'Unknown';
        const licElement = row.querySelector('.lic');
        const irElement = row.querySelector('.ir');

        // License, Add a class by the first letter of the license
        if (car.license) {
            licElement.textContent = car.license;
            licElement.className = 'lic';
            const licClass = car.license.charAt(0).toLowerCase();
            licElement.classList.add(licClass);
        } else {
            licElement.textContent = '--';
            licElement.className = 'lic';
        }

        // iRating
        irElement.textContent = car.irating ? Math.floor(car.irating/100)/10 + 'k' : '--';
        
        // Update the last lap time
        row.querySelector('.time').textContent = car.last_lap || '--:--.---';
    }

    showError(message) {
        console.error('Error:', message);
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', () => {
    new LeaderboardUpdater();
});
</script>
{% endblock %}
