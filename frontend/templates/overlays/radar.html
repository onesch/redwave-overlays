{% extends "base/base_overlay.html" %}
{% block title %}radar{% endblock %}

{% block content %}
<div class="radar-container">
  <div class="radar-line horizontal"></div>
  <div class="radar-line vertical"></div>

  <div class="my-car"></div>

  <!-- полосы впереди/сзади -->
  <div id="fb-ahead" class="fb-box ahead">
    <div class="clipper"></div>
  </div>

  <div id="fb-behind" class="fb-box behind">
    <div class="clipper"></div>
  </div>

  <!-- боковые -->
  <div id="side-left"  class="side-box left"></div>
  <div id="side-right" class="side-box right"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
const MAX_DIST = 15.0;
const RADAR_H = 260;
const CENTER_Y = RADAR_H / 2;

function setFB(el, dist, severity){
  if(dist == null){
    el.style.opacity = 0;
    return;
  }
  el.style.opacity = 1;

  let color;
  switch(severity){
    case "red":    color = "rgba(255,0,0,0.75)"; break;
    case "yellow": color = "rgba(255,255,0,0.65)"; break;
    case "ok":     color = "rgba(255,255,255,0.45)"; break;
    default:       color = "rgba(180,180,180,0.45)";
  }
  el.style.background = `radial-gradient(circle at bottom, ${color} 0%, rgba(255,255,255,0) 100%)`;
}


function setSide(el, info){
  el.classList.remove("sev-red","sev-yellow","sev-ok","sev-gray");
  if(!info){
    el.style.opacity = 0;
    return;
  }
  el.style.opacity = 1;

  // Просто фиксированная позиция (по умолчанию)
  el.style.top = (CENTER_Y) + "px";

  switch(info.severity){
    case "red": el.classList.add("sev-red"); break;
    case "yellow": el.classList.add("sev-yellow"); break;
    case "ok": el.classList.add("sev-ok"); break;
    case "gray": el.classList.add("sev-gray"); break;
    default: el.classList.add("sev-ok");
  }
}

async function updateRadar(){
  try {
    // anti-cache
    const r = await fetch("/api/radar?ts=" + Date.now());
    if(!r.ok) return;
    const data = await r.json();

    setFB(document.getElementById("fb-ahead"),  data.ahead_m,  data.ahead_severity);
    setFB(document.getElementById("fb-behind"), data.behind_m, data.behind_severity);

    setSide(document.getElementById("side-left"),  data.left);
    setSide(document.getElementById("side-right"), data.right);

  } catch(e){
    console.error("radar fetch error", e);
  }
}

setInterval(updateRadar, 100);
updateRadar();
</script>
{% endblock %}